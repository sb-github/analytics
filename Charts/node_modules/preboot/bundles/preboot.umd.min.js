!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("@angular/core"),require("@angular/common")):"function"==typeof define&&define.amd?define(["exports","@angular/core","@angular/common"],t):t(e.preboot=e.preboot||{},e.ng.core,e.ng.common)}(this,function(e,t,o){"use strict";function n(e){for(var t=[],o=e.root,n=e.node,r=n;r&&r!==o.serverNode&&r!==o.clientNode;)t.push(r),r=r.parentNode;r&&t.push(r);for(var i=(n.nodeName||"unknown")+"_"+o.serverSelector,a=t.length-1;a>=0;a--)if((r=t[a]).childNodes&&a>0)for(var c=0;c<r.childNodes.length;c++)if(r.childNodes[c]===t[a-1]){i+="_s"+(c+1);break}return i}function r(){return{prebootData:window.prebootData,prebootStarted:!1,getComputedStyle:window.getComputedStyle,document:document}}function i(e,t){a((t||window).prebootData={opts:e,listening:!0,apps:[],listeners:[]})}function a(e,t){((t||window).document||{}).body?c(e):setTimeout(function(){a(e)},10)}function c(e,t){var o=t||window;if(!o.prebootStarted){o.prebootStarted=!0;var n=o.document||{},r=(e.opts||{}).eventSelectors||[];e.overlay=l(n);(e.opts?s(n,e.opts):[]).forEach(function(t){var o={root:t,events:[]};e.apps&&e.apps.push(o),r.forEach(function(t){return u(e,o,t)})})}}function l(e){var t=void 0;return e.createElement&&((t=e.createElement("div")).setAttribute("id","prebootOverlay"),t.setAttribute("style","display:none;position:absolute;left:0;top:0;width:100%;height:100%;z-index:999999;background:black;opacity:.3"),e.body.appendChild(t)),t}function s(e,t){var o=[];if(t.appRoot&&t.appRoot.length){[].concat(t.appRoot).forEach(function(e){return o.push({serverSelector:e})})}return o.map(function(o){return o.serverNode=e.querySelector(o.serverSelector),o.clientSelector=o.clientSelector||o.serverSelector,o.clientSelector!==o.serverSelector?o.clientNode=e.querySelector(o.clientSelector):o.clientNode=t.buffer?f(o):o.serverNode,o.serverNode||console.log("No server node found for selector: "+o.serverSelector),o})}function u(e,t,o){var n=t.root.serverNode;if(n){var r=n.querySelectorAll(o.selector);if(r)for(var i=function(n){o.events.forEach(function(r){var i=d(e,o,t,n);n.addEventListener(r,i),e.listeners&&e.listeners.push({node:n,eventName:r,handler:i})})},a=0,c=Array.from(r);a<c.length;a++){i(c[a])}}}function d(e,t,o,r){var i=["keyup","keydown","focusin","mouseup","mousedown"],a=["INPUT","TEXTAREA"];return function(c){var l=o.root,s=c.type;if(r&&s){var u=t.keyCodes;if(u&&u.length){if(!u.filter(function(e){return c.which===e}).length)return}t.preventDefault&&c.preventDefault(),t.action&&t.action(r,c);var d=n({root:l,node:r});if(i.indexOf(s)>=0&&a.indexOf(r.tagName)>=0?e.activeNode={root:l,node:r,nodeKey:d,selection:p(r)}:"change"!==s&&"focusout"!==s&&(e.activeNode=void 0),t.freeze){var f=e.overlay;f.style.display="block",setTimeout(function(){f.style.display="none"},1e4)}t.noReplay||o.events.push({node:r,nodeKey:d,event:c,name:s})}}}function p(e){var t=(e=e||{}).value||"",o={start:t.length,end:t.length,direction:"forward"};try{(e.selectionStart||0===e.selectionStart)&&(o.start=e.selectionStart,o.end=e.selectionEnd,o.direction=e.selectionDirection)}catch(e){}return o}function f(e){var t=e.serverNode;if(!t||!t.parentNode||"html"===e.serverSelector||"body"===e.serverSelector)return t;var o=t.cloneNode(!1);return o.style.display="none",t.parentNode.insertBefore(o,t),o}function v(){var e=[];for(var t in E)if(E.hasOwnProperty(t)){var o=E[t].toString().replace("common_1.","");e.push(o)}return e.push(n.toString()),"\n\n"+e.join("\n\n")+"\n\n"}function h(e){var t=g({},O,e);y(t);var o=m(t);return"(function() {\n      "+v()+"\n      ("+i.toString().replace("common_1.","")+"\n      )("+o+")\n    })()"}function y(e){if(!e.appRoot||!e.appRoot.length)throw new Error("The appRoot is missing from preboot options. This is needed to find the root of your application. Set this value in the preboot options to be a selector for the root element of your app.")}function g(e){for(var t=[],o=1;o<arguments.length;o++)t[o-1]=arguments[o];if(void 0===e||null===e)throw new TypeError("Cannot convert undefined or null to object");for(var n=Object(e),r=0;r<t.length;r++){var i=t[r];if(void 0!==i&&null!==i)for(var a in i)i.hasOwnProperty&&i.hasOwnProperty(a)&&(n[a]=i[a])}return n}function m(e){for(var t,o,n="START_FUNCTION_HERE",r="STOP_FUNCTION_HERE",i=JSON.stringify(e,function(e,t){return t&&t.constructor&&t.call&&t.apply?n+t.toString()+r:t}),a=i.indexOf(n);a>=0;)t=i.indexOf(r),o=(o=i.substring(a+n.length,t)).replace(/\\n/g,"\n"),a=(i=i.substring(0,a-1)+o+i.substring(t+r.length+1)).indexOf(n);return i}function N(e,n,r,i,a){return function(){if(o.isPlatformServer(a)){var c=h(r),l={id:"-1",encapsulation:t.ViewEncapsulation.None,styles:[],data:{}},s=n.createRenderer(e,l),u=s.createElement("script");i&&s.setProperty(u,"nonce",i),s.setValue(u,c),s.insertBefore(e.head,u,e.head.firstChild)}}}function S(e,t,n){return function(){o.isPlatformBrowser(n)&&!t.noReplay&&e.replayAll()}}var w=new t.InjectionToken("PrebootNonce"),b=function(){function e(){this.clientNodeCache={},this.replayStarted=!1}return e.prototype.setWindow=function(e){this.win=e},e.prototype.getWindow=function(){return this.win||(this.win=r()),this.win},e.prototype.replayAll=function(){var e=this;if(!this.replayStarted){this.replayStarted=!0;var t=this.getWindow().prebootData||{};(t.apps||[]).forEach(function(t){return e.replayForApp(t)}),this.cleanup(t)}},e.prototype.replayForApp=function(e){var t=this;e=e||{};try{var o=e.root||{},n=e.events||[],r=this.getWindow().document,i=o.clientSelector;null!=i&&(o.clientNode=r.querySelector(i)),n.forEach(function(o){return t.replayEvent(e,o)})}catch(e){console.error(e)}this.switchBuffer(e)},e.prototype.replayEvent=function(e,t){e=e||{};var o=(t=t||{}).event,n=t.node||{},r=t.nodeKey,i=this.findClientNode({root:e.root,node:n,nodeKey:r});if(!i)return console.warn("Trying to dispatch event "+o.type+" to node "+r+" but could not find client node. Server node is: "),void console.log(n);i.checked=n.checked,i.selected=n.selected,i.value=n.value,i.dispatchEvent(o)},e.prototype.switchBuffer=function(e){var t=(e=e||{}).root||{},o=t.serverNode,n=t.clientNode;if(n&&o&&o!==n&&"BODY"!==o.nodeName)try{var r=(0,this.getWindow().getComputedStyle)(o).getPropertyValue("display")||"block";o.remove?o.remove():o.style.display="none",n.style.display=r}catch(e){console.error(e)}},e.prototype.cleanup=function(e){var t=this,o=(e=e||{}).listeners||[],n=e.activeNode;null!=n&&setTimeout(function(){return t.setFocus(n)},1);for(var r=0,i=o;r<i.length;r++){var a=i[r];a.node.removeEventListener(a.eventName,a.handler)}var c=this.getWindow().document,l=c.body.querySelector("#prebootOverlay");l&&l.remove(),e.apps=[],this.clientNodeCache={};var s=new Event("PrebootComplete");c.dispatchEvent(s)},e.prototype.setFocus=function(e){if(e&&e.node&&e.nodeKey){var t=this.findClientNode(e);if(t){t.focus();var o=e.selection;if(t.setSelectionRange&&o)try{t.setSelectionRange(o.start,o.end,o.direction)}catch(e){}}}},e.prototype.findClientNode=function(e){var t=(e=e||{}).node,o=e.root;if(!o||!o.serverNode||!o.clientNode)return null;var r=e.nodeKey||n(e);if(this.clientNodeCache[r])return this.clientNodeCache[r];var i=(t.className||"").replace("ng-binding","").trim(),a=t.tagName;t.id?a+="#"+t.id:i&&(a+="."+i.replace(/ /g,"."));var c=o.clientNode,l=c.querySelectorAll(a);l.length||(console.log("nothing found for "+a+" so using "+t.tagName),l=c.querySelectorAll(t.tagName));for(var s=0,u=Array.from(l);s<u.length;s++){var d=u[s];if(n({root:o,node:d})===r)return this.clientNodeCache[r]=d,d}return 1===l.length?(this.clientNodeCache[r]=l[0],l[0]):(console.warn("No matching client node found for "+r+". You can fix this by assigning this element a unique id attribute."),null)},e}(),E={waitUntilReady:a,start:c,createOverlay:l,getAppRoots:s,handleEvents:u,createListenHandler:d,getSelection:p,createBuffer:f},O={buffer:!0,minify:!0,eventSelectors:[{selector:"input,textarea",events:["keypress","keyup","keydown","input","change"]},{selector:"select,option",events:["change"]},{selector:"input",events:["keyup"],preventDefault:!0,keyCodes:[13],freeze:!0},{selector:"form",events:["submit"],preventDefault:!0,freeze:!0},{selector:"input,textarea",events:["focusin","focusout","mousedown","mouseup"],noReplay:!0},{selector:"button",events:["click"],preventDefault:!0,freeze:!0}]},R=new t.InjectionToken("PrebootOptions"),T=function(){function e(){}return e.withConfig=function(n){return{ngModule:e,providers:[b,{provide:R,useValue:n},{provide:t.APP_BOOTSTRAP_LISTENER,useFactory:N,deps:[o.DOCUMENT,t.RendererFactory2,R,[new t.Optional,new t.Inject(w)],t.PLATFORM_ID],multi:!0},{provide:t.APP_BOOTSTRAP_LISTENER,useFactory:S,deps:[b,R,t.PLATFORM_ID],multi:!0}]}},e.decorators=[{type:t.NgModule}],e.ctorParameters=function(){return[]},e}();e.getNodeKeyForPreboot=n,e.PREBOOT_NONCE=w,e._window=r,e.EventReplayer=b,e.init=i,e.waitUntilReady=a,e.start=c,e.createOverlay=l,e.getAppRoots=s,e.handleEvents=u,e.createListenHandler=d,e.getSelection=p,e.createBuffer=f,e.defaultOptions=O,e.getEventRecorderCode=v,e.getInlinePrebootCode=h,e.validateOptions=y,e.assign=g,e.stringifyWithFunctions=m,e.PREBOOT_OPTIONS=R,e.addScript=N,e.replay=S,e.PrebootModule=T,Object.defineProperty(e,"__esModule",{value:!0})});
//# sourceMappingURL=preboot.umd.min.js.map
